import java.io.FileReader;
import java.io.FileWriter;
import java.io.IOException;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.time.format.DateTimeParseException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Objects;
import java.util.Optional;
import java.util.UUID;
import java.util.stream.Collectors;

import org.json.simple.JSONArray;
import org.json.simple.JSONObject;
import org.json.simple.parser.JSONParser;
import org.json.simple.parser.ParseException;

public class App {

    public static void main(String[] args) {
        ITaskRepository taskRepository = new JsonTaskRepository();
        PersonalTaskManager manager = new PersonalTaskManager(taskRepository);

        System.out.println("--- Minh họa thêm nhiệm vụ ---");
        manager.addNewTask(
                "Mua sách",
                "Sách Công nghệ phần mềm.",
                "2025-07-20",
                "Cao"
        ).ifPresent(task -> System.out.println("Nhiệm vụ đã thêm: " + task));

        System.out.println("\n--- Minh họa thêm nhiệm vụ trùng lặp ---");
        manager.addNewTask(
                "Mua sách",
                "Sách Công nghệ phần mềm.",
                "2025-07-20",
                "Cao"
        );

        System.out.println("\n--- Minh họa thêm nhiệm vụ với tiêu đề rỗng ---");
        manager.addNewTask(
                "",
                "Nhiệm vụ không có tiêu đề.",
                "2025-07-22",
                "Thấp"
        );

        System.out.println("\n--- Minh họa thêm nhiệm vụ với ngày không hợp lệ ---");
        manager.addNewTask(
                "Lên kế hoạch",
                "Lên kế hoạch cho dự án mới.",
                "2025/07/23",
                "Trung bình"
        );

        System.out.println("\n--- Minh họa thêm nhiệm vụ với mức độ ưu tiên không hợp lệ ---");
        manager.addNewTask(
                "Học Java",
                "Học các khái niệm OOP.",
                "2025-07-24",
                "Rất cao"
        );

        System.out.println("\n--- Thêm các nhiệm vụ khác để minh họa cập nhật/xóa ---");
        Optional<Task> task2 = manager.addNewTask(
                "Viết báo cáo",
                "Báo cáo cuối kỳ.",
                "2025-07-25",
                "Cao"
        );
        Optional<Task> task3 = manager.addNewTask(
                "Gặp khách hàng",
                "Thảo luận dự án.",
                "2025-07-26",
                "Trung bình"
        );

        System.out.println("\n--- Minh họa cập nhật trạng thái nhiệm vụ ---");
        if (task2.isPresent()) {
            manager.updateTaskStatus(task2.get().getId(), "Đã hoàn thành");
        } else {
            System.out.println("Không thể cập nhật: Nhiệm vụ 2 không được tạo.");
        }

        System.out.println("\n--- Minh họa xóa nhiệm vụ ---");
        if (task3.isPresent()) {
            manager.deleteTask(task3.get().getId());
        } else {
            System.out.println("Không thể xóa: Nhiệm vụ 3 không được tạo.");
        }

        System.out.println("\n--- Tất cả nhiệm vụ hiện có trong DB ---");
        List<Task> allTasks = taskRepository.getAllTasks();
        if (allTasks.isEmpty()) {
            System.out.println("Không có nhiệm vụ nào trong DB.");
        } else {
            allTasks.forEach(System.out::println);
        }
    }
}

class Task {
    private String id;
    private String title;
    private String description;
    private LocalDate dueDate;
    private String priority;
    private String status;
    private LocalDateTime createdAt;
    private LocalDateTime lastUpdatedAt;

    public Task(String id, String title, String description, LocalDate dueDate,
                String priority, String status, LocalDateTime createdAt, LocalDateTime lastUpdatedAt) {
        this.id = id;
        this.title = title;
        this.description = description;
        this.dueDate = dueDate;
        this.priority = priority;
        this.status = status;
        this.createdAt = createdAt;
        this.lastUpdatedAt = lastUpdatedAt;
    }

    public Task(String title, String description, LocalDate dueDate, String priority) {
        this.id = UUID.randomUUID().toString();
        this.title = title;
        this.description = description;
        this.dueDate = dueDate;
        this.priority = priority;
        this.status = "Chưa hoàn thành";
        this.createdAt = LocalDateTime.now();
        this.lastUpdatedAt = LocalDateTime.now();
    }

    public String getId() { return id; }
    public String getTitle() { return title; }
    public String getDescription() { return description; }
    public LocalDate getDueDate() { return dueDate; }
    public String getPriority() { return priority; }
    public String getStatus() { return status; }
    public LocalDateTime getCreatedAt() { return createdAt; }
    public LocalDateTime getLastUpdatedAt() { return lastUpdatedAt; }

    public void setTitle(String title) {
        this.title = title;
        this.lastUpdatedAt = LocalDateTime.now();
    }
    public void setDescription(String description) {
        this.description = description;
        this.lastUpdatedAt = LocalDateTime.now();
    }
    public void setDueDate(LocalDate dueDate) {
        this.dueDate = dueDate;
        this.lastUpdatedAt = LocalDateTime.now();
    }
    public void setPriority(String priority) {
        this.priority = priority;
        this.lastUpdatedAt = LocalDateTime.now();
    }
    public void setStatus(String status) {
        this.status = status;
        this.lastUpdatedAt = LocalDateTime.now();
    }

    @SuppressWarnings("unchecked")
    public JSONObject toJsonObject() {
        JSONObject obj = new JSONObject();
        obj.put("id", this.id);
        obj.put("title", this.title);
        obj.put("description", this.description);
        obj.put("due_date", this.dueDate.format(DateTimeFormatter.ISO_LOCAL_DATE));
        obj.put("priority", this.priority);
        obj.put("status", this.status);
        obj.put("created_at", this.createdAt.format(DateTimeFormatter.ISO_DATE_TIME));
        obj.put("last_updated_at", this.lastUpdatedAt.format(DateTimeFormatter.ISO_DATE_TIME));
        return obj;
    }

    public static Task fromJsonObject(JSONObject obj) {
        String id = (String) obj.get("id");
        String title = (String) obj.get("title");
        String description = (String) obj.get("description");
        LocalDate dueDate = LocalDate.parse((String) obj.get("due_date"), DateTimeFormatter.ISO_LOCAL_DATE);
        String priority = (String) obj.get("priority");
        String status = (String) obj.get("status");
        LocalDateTime createdAt = LocalDateTime.parse((String) obj.get("created_at"), DateTimeFormatter.ISO_DATE_TIME);
        LocalDateTime lastUpdatedAt = LocalDateTime.parse((String) obj.get("last_updated_at"), DateTimeFormatter.ISO_DATE_TIME);

        return new Task(id, title, description, dueDate, priority, status, createdAt, lastUpdatedAt);
    }

    @Override
    public String toString() {
        return "Task{" +
               "id='" + id + '\'' +
               ", title='" + title + '\'' +
               ", dueDate=" + dueDate +
               ", priority='" + priority + '\'' +
               ", status='" + status + '\'' +
               '}';
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        Task task = (Task) o;
        return id.equals(task.id);
    }

    @Override
    public int hashCode() {
        return Objects.hash(id);
    }
}

interface ITaskRepository {
    List<Task> getAllTasks();
    Optional<Task> findById(String id);
    void save(Task task);
    void delete(String id);
    boolean existsByTitleAndDueDate(String title, String dueDateFormatted);
}

class JsonTaskRepository implements ITaskRepository {

    private static final String DB_FILE_PATH = "tasks_database.json";
    private static final DateTimeFormatter DATE_FORMATTER = DateTimeFormatter.ISO_LOCAL_DATE;

    private JSONArray loadJsonArrayFromFile() {
        JSONParser parser = new JSONParser();
        try (FileReader reader = new FileReader(DB_FILE_PATH)) {
            Object obj = parser.parse(reader);
            if (obj instanceof JSONArray) {
                return (JSONArray) obj;
            }
        } catch (IOException | ParseException e) {
            System.err.println("Lỗi khi đọc file database: " + e.getMessage());
        }
        return new JSONArray();
    }

    private void saveJsonArrayToFile(JSONArray tasksData) {
        try (FileWriter file = new FileWriter(DB_FILE_PATH)) {
            file.write(tasksData.toJSONString());
            file.flush();
        } catch (IOException e) {
            System.err.println("Lỗi khi ghi vào file database: " + e.getMessage());
        }
    }

    @Override
    public List<Task> getAllTasks() {
        JSONArray jsonTasks = loadJsonArrayFromFile();
        List<Task> tasks = new ArrayList<>();
        for (Object obj : jsonTasks) {
            tasks.add(Task.fromJsonObject((JSONObject) obj));
        }
        return tasks;
    }

    @Override
    public Optional<Task> findById(String id) {
        return getAllTasks().stream()
                .filter(task -> task.getId().equals(id))
                .findFirst();
    }

    @Override
    @SuppressWarnings("unchecked")
    public void save(Task task) {
        JSONArray jsonTasks = loadJsonArrayFromFile();
        boolean found = false;

        for (int i = 0; i < jsonTasks.size(); i++) {
            JSONObject existingJsonTask = (JSONObject) jsonTasks.get(i);
            if (existingJsonTask.get("id").equals(task.getId())) {
                jsonTasks.set(i, task.toJsonObject());
                found = true;
                break;
            }
        }

        if (!found) {
            jsonTasks.add(task.toJsonObject());
        }
        saveJsonArrayToFile(jsonTasks);
    }

    @Override
    public void delete(String id) {
        JSONArray jsonTasks = loadJsonArrayFromFile();
        JSONArray updatedJsonTasks = jsonTasks.stream()
                .filter(obj -> !((JSONObject) obj).get("id").equals(id))
                .collect(Collectors.toCollection(JSONArray::new));
        
        if (updatedJsonTasks.size() < jsonTasks.size()) {
            saveJsonArrayToFile(updatedJsonTasks);
        }
    }

    @Override
    public boolean existsByTitleAndDueDate(String title, String dueDateFormatted) {
        return getAllTasks().stream()
                .anyMatch(task -> task.getTitle().equalsIgnoreCase(title) &&
                                 task.getDueDate().format(DATE_FORMATTER).equals(dueDateFormatted));
    }
}

class TaskValidator {

    private static final DateTimeFormatter DATE_FORMATTER = DateTimeFormatter.ISO_LOCAL_DATE;
    private static final List<String> VALID_PRIORITIES = Arrays.asList("Thấp", "Trung bình", "Cao");

    public static boolean isValidTitle(String title) {
        if (title == null || title.trim().isEmpty()) {
            System.out.println("Lỗi xác thực: Tiêu đề không được để trống.");
            return false;
        }
        return true;
    }

    public static boolean isValidDescription(String description) {
        return true;
    }

    public static boolean isValidDueDate(String dueDateStr) {
        if (dueDateStr == null || dueDateStr.trim().isEmpty()) {
            System.out.println("Lỗi xác thực: Ngày đến hạn không được để trống.");
            return false;
        }
        try {
            LocalDate.parse(dueDateStr, DATE_FORMATTER);
            return true;
        } catch (DateTimeParseException e) {
            System.out.println("Lỗi xác thực: Ngày đến hạn không hợp lệ. Vui lòng sử dụng định dạng YYYY-MM-DD.");
            return false;
        }
    }

    public static boolean isValidPriority(String priorityLevel) {
        if (priorityLevel == null || priorityLevel.trim().isEmpty()) {
            System.out.println("Lỗi xác thực: Mức độ ưu tiên không được để trống.");
            return false;
        }
        if (!VALID_PRIORITIES.contains(priorityLevel)) {
            System.out.println("Lỗi xác thực: Mức độ ưu tiên không hợp lệ. Vui lòng chọn từ: Thấp, Trung bình, Cao.");
            return false;
        }
        return true;
    }
}

class PersonalTaskManager {

    private final ITaskRepository taskRepository;
    private static final DateTimeFormatter DATE_FORMATTER = DateTimeFormatter.ISO_LOCAL_DATE;

    public PersonalTaskManager(ITaskRepository taskRepository) {
        this.taskRepository = taskRepository;
    }

    public Optional<Task> addNewTask(String title, String description,
                                    String dueDateStr, String priorityLevel) {

        if (!TaskValidator.isValidTitle(title) ||
            !TaskValidator.isValidDueDate(dueDateStr) ||
            !TaskValidator.isValidPriority(priorityLevel)) {
            return Optional.empty();
        }

        LocalDate dueDate = LocalDate.parse(dueDateStr, DATE_FORMATTER);
        String formattedDueDate = dueDate.format(DATE_FORMATTER);

        if (taskRepository.existsByTitleAndDueDate(title, formattedDueDate)) {
            System.out.println(String.format("Lỗi: Nhiệm vụ '%s' đã tồn tại với cùng ngày đến hạn (%s).", title, formattedDueDate));
            return Optional.empty();
        }

        Task newTask = new Task(title, description, dueDate, priorityLevel);
        taskRepository.save(newTask);

        System.out.println(String.format("Đã thêm nhiệm vụ mới thành công với ID: %s", newTask.getId()));
        return Optional.of(newTask);
    }

    public boolean updateTaskStatus(String taskId, String newStatus) {
        if (!newStatus.equals("Chưa hoàn thành") && !newStatus.equals("Đã hoàn thành")) {
            System.out.println("Lỗi: Trạng thái không hợp lệ. Vui lòng chọn 'Chưa hoàn thành' hoặc 'Đã hoàn thành'.");
            return false;
        }

        Optional<Task> taskOpt = taskRepository.findById(taskId);
        if (taskOpt.isPresent()) {
            Task task = taskOpt.get();
            task.setStatus(newStatus);
            taskRepository.save(task);
            System.out.println(String.format("Đã cập nhật trạng thái nhiệm vụ ID '%s' thành '%s'.", taskId, newStatus));
            return true;
        } else {
            System.out.println(String.format("Lỗi: Không tìm thấy nhiệm vụ với ID '%s'.", taskId));
            return false;
        }
    }

    public boolean deleteTask(String taskId) {
        Optional<Task> taskOpt = taskRepository.findById(taskId);
        if (taskOpt.isPresent()) {
            taskRepository.delete(taskId);
            System.out.println(String.format("Đã xóa nhiệm vụ với ID '%s'.", taskId));
            return true;
        } else {
            System.out.println(String.format("Lỗi: Không tìm thấy nhiệm vụ với ID '%s' để xóa.", taskId));
            return false;
        }
    }
}
